{% extends "base/base.html" %}
{% load static %}

{% block title %}Helpline Call Center{% endblock %}
{% block page_heading %}24/7 Emergency Call Center Console{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/helpline_agent.css' %}">
{% endblock %}

{% block content %}
    <div class="helpline-console-grid">
        <!-- Column 1: Caller Info & Search -->
        <div class="panel caller-info-panel">
            <h3>Caller Identification</h3>
            <input type="text" id="caller-search" placeholder="Enter Phone No. or IoT Device ID">
            <button class="btn btn-secondary" onclick="searchCaller()">Load User</button>
            
            <div id="user-details" class="details-box">
                <h4>Loaded User: <span id="user-name">N/A</span></h4>
                <p>Status: <span id="user-subscription" class="status-badge status-premium">PREMIUM (Subscription)</span></p>
                <p>Vehicle: <span id="user-vehicle">Maruti Swift (MH12-ABCD)</span></p>
                <p>Last Signal: <span id="last-signal">5 minutes ago (via IoT)</span></p>
                <p>Location: <span id="user-last-location">Near Pune-Mumbai Expressway, Exit 25</span></p>
            </div>
            
            <h3 style="margin-top: 20px;">Customer History</h3>
            <ul id="ticket-history">
                <li><a href="#">#890: Heavy Towing (2025-09-15) - Resolved</a></li>
                <li class="active-ticket"><a href="#">#952: Current Active Request - Pending SP</a></li>
            </ul>
        </div>

        <!-- Column 2: New Request & Dispatch Form -->
        <div class="panel new-request-panel">
            <h3>Create New Service Ticket</h3>
            <div class="call-status-widget status-ringing">
                <span id="call-status-text">CALL IN PROGRESS...</span>
            </div>
            
            <form id="new-ticket-form">
                <label for="issue">Nature of Issue (Required):</label>
                <select id="issue">
                    <option value="TOWING">Heavy Towing / Accident</option>
                    <option value="FLAT_TIRE">Flat Tire / Puncture</option>
                    <option value="BATTERY">Battery Jumpstart / Replacement</option>
                    <option value="FUEL">Fuel Delivery (Out of Gas)</option>
                    <option value="LOCKOUT">Lockout / Key Retrieval</option>
                </select>

                <label for="manual_location">Current Location (Manual Override):</label>
                <input type="text" id="manual_location" placeholder="Enter landmark or exact address given by caller">
                
                <label for="caller_notes">Agent Notes:</label>
                <textarea id="caller_notes" rows="3" placeholder="Caller seems distressed. Confirmed vehicle model and color."></textarea>
                
                <button type="button" class="btn btn-primary btn-lg" onclick="dispatchManualRequest()">
                    DISPATCH URGENT REQUEST
                </button>
            </form>
        </div>
        
        <!-- Column 3: Embedded Live Map -->
        <div class="panel map-panel">
            <h3>Live Dispatch Overview</h3>
            <div id="helpline-map-container" style="height: 500px;">
                <!-- Map API will render here -->
                <p class="map-loading">Loading Map and Live Providers...</p>
            </div>
            <div class="map-legend">
                <span class="legend-item"><i class="icon-dot-red"></i> Emergency Requests</span>
                <span class="legend-item"><i class="icon-dot-green"></i> Available Providers</span>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/helpline_logic.js' %}"></script>
<!-- Placeholder for map library load -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GMAPS_KEY&callback=initMap"></script>
{% endblock %}
