name: Deploy Vehic-Aid

on:
  push:
    branches: [ "main", "feat/admin-backend-docs" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
        
    - name: Install Dependencies
      run: |
        ls -la
        ls -la backend
        python -m pip install --upgrade pip
        pip install -r backend/requirements-final.txt
        
    - name: Run Tests
      working-directory: ./backend
      env:
        SECRET_KEY: test-key
        DEBUG: True
      run: |
        # Use simple sqlite for CI testing
        pytest

  build-and-deploy:
    needs: test-backend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feat/admin-backend-docs'
    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: false
        tags: vehic-aid/backend:latest

    - name: Build Booker App
      uses: docker/build-push-action@v5
      with:
        context: ./web/booker
        push: false
        tags: vehic-aid/booker:latest

    - name: Build Provider App
      uses: docker/build-push-action@v5
      with:
        context: ./web/provider
        push: false
        tags: vehic-aid/provider:latest

    - name: Build Admin Panel
      uses: docker/build-push-action@v5
      with:
        context: ./web/admin
        push: false
        tags: vehic-aid/admin:latest

    - name: Simulate Deployment Check
      run: |
        echo "Docker images built successfully."
        echo "Ready for deployment to staging/production."
