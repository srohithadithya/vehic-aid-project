name: Deploy Vehic-Aid

on:
  push:
    branches: [ "main", "feat/admin-backend-docs" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        
    - name: Run Tests
      working-directory: ./backend
      env:
        SECRET_KEY: test-key
        DEBUG: True
      run: |
        # Use simple sqlite for CI testing
        pytest

  build-and-deploy:
    needs: test-backend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feat/admin-backend-docs'
    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # In a real scenario, we would login to a registry here
    # - name: Login to Docker Hub
    #   uses: docker/login-action@v3
    #   with:
    #     username: ${{ secrets.DOCKERHUB_USERNAME }}
    #     password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: false # Set to true if registry is configured
        tags: vehic-aid/backend:latest

    - name: Build Booker App
      uses: docker/build-push-action@v5
      with:
        context: ./web-booker
        push: false
        tags: vehic-aid/booker:latest

    - name: Build Provider App
      uses: docker/build-push-action@v5
      with:
        context: ./web-provider
        push: false
        tags: vehic-aid/provider:latest

    - name: Simulate Deployment Check
      run: |
        echo "Docker images built successfully."
        echo "Ready for deployment to staging/production."
